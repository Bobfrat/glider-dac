{% from "macros.html" import render_field, render_field_static, render_boolean %}
{% extends "layout.html" %}

{% block title %}{{ mission.name }}{% endblock %}

{% block page %}

<h3>{{ mission.name }}</h3>

<div class="col-lg-6">

  <h3>Files</h3>

  <table class="table table-striped">
    <thead>
      <tr>
        <th>File</th>
        <th>Modified</th>
      </tr>
    </thead>
    <tbody>
    {% for f in files %}
      <tr>
        <td>{{ f[0] }}</td>
        <td>{{ f[1] | datetimeformat }}</td>
      </tr>
    {% endfor %}
    </tbody>
  </table>

  {% if editable %}

  <div id="dropbox">
    <span>Drop files here to upload</span>

    <div class="progress">
      <div class="progress-bar" style="width:0%">
      </div>
    </div>
  </div>

  <script type="text/javascript">
    $(function() {
      var drop = $('#dropbox');

      drop.on('dragover', function(e) {
        e.preventDefault();
        e.stopPropagation();
      });

      drop.on('dragenter', function(e) {
        e.preventDefault();
        e.stopPropagation();

        $(this).addClass('hovered');
      });

      drop.on('dragleave', function(e) {
        $(this).removeClass('hovered'); 
      });

      drop.on('drop', function(e) {
        // prevent browser from just displaying file
        e.preventDefault();
        e.stopPropagation();

        // do not allow more than one upload event going on at once or no need for empty file list
        if ($(this).hasClass('uploading') || e.originalEvent.dataTransfer.files.length == 0) {
          return;
        }

        $(this).removeClass('hovered');       
        $(this).addClass('uploading');

        var formData = new FormData();

        for (var i = 0; i < e.originalEvent.dataTransfer.files.length; i++) {
          var f = e.originalEvent.dataTransfer.files[i];
          console.log(f);

          formData.append('file-' + i, f);
        }

        console.log(formData);

        var url = "{{ url_for('post_mission_file', username=username, mission_id=mission._id) }}";

        var req = $.ajax({
          xhr: function() {
            var x = jQuery.ajaxSettings.xhr();
            x.upload.addEventListener('progress', function(evt) {

              console.log("RPGORESS");

              if (evt.lengthComputable) {
                var pct = evt.loaded / evt.total * 100;
                $('.progress-bar').attr('style', 'width:' + pct + '%;');
              };
            }, false);
            return x;
          },
          type: 'POST',
          cache: false,
          contentType: false,
          processData: false,
          url: url,
          data: formData,
        });

        req.always(function() {
          drop.removeClass('uploading');
        });

        req.fail(function() {
          console.error("FAIL");
        });

        req.done(function(data) {
          console.log(data);

          for (var i = 0; i < data.files.length; i++) {
            var f = data.files[i];
            var row = $('<tr><td>' + f[0] + '</td><td>' + f[1] + '</td></tr>');
            $('tbody').prepend(row);
          }
        
        });

      });
    });
  </script>

  {% endif %}

</div>

<div class="col-lg-4">

  <h3>Services</h3>

  <ul class="list-group">
    <li class="list-group-item">
      <a href='{{mission.dap}}'>DAP</a>
    </li>
    <li class="list-group-item">
      <a href='{{mission.sos}}'>SOS</a>
    </li>
    <li class="list-group-item">
      <a href='{{mission.iso}}'>ISO</a>
    </li>      
  </ul>

  {% if editable %}
  <hr />
  <h3>Edit</h3>

  <form name="mission_edit" id="mission_edit" method="POST" action="{{ url_for('edit_mission', username=username, mission_id=mission._id) }}">
    {{ form.hidden_tag() }}
    {{ render_field(form.estimated_deploy_date) }}
    {{ render_field(form.estimated_deploy_location) }}
    {{ render_field(form.wmo_id) }}
    {{ render_boolean(form.completed) }}
    {{ form.submit(class_="btn btn-primary") }}
  </form>
  {% else %}
  <form name="mission_edit" id="mission_edit" method="POST" action="">
    {{ render_field_static(form.estimated_deploy_date) }}
    {{ render_field_static(form.estimated_deploy_location) }}
    {{ render_field_static(form.wmo_id) }}
    {{ render_field_static(form.completed) }}
  </form>
  {% endif %}

</div>


{% endblock %}
